function Invoke-YaraAndPEStudio {
    # Path to the YARA executable
    $yaraPath = "C:\Path\To\YARA.exe"

    # Path to the YARA rule file
    $yaraRuleFile = "C:\Path\To\RuleFile.yar"

    # Path to the file or directory to scan
    $targetPath = "C:\Path\To\Target"

    # Run YARA command to scan the target using the specified rule file
    $result = & $yaraPath $yaraRuleFile $targetPath

    # Process the YARA scan result
    if ($result) {
        Write-Host "IOC detected in the target:"
        foreach ($line in $result) {
            Write-Host $line
        }

        # Path to the PEStudio executable
        $pestudioPath = "C:\Path\To\PEStudio\PEStudio.exe"

        # Path to the executable file to analyze
        $executablePath = $result  # Use the YARA result as the input for PEStudio

        # Run PEStudio in command-line mode and save the analysis report to a temporary file
        $reportPath = [System.IO.Path]::GetTempFileName()
        & $pestudioPath -file $executablePath -quiet -export -string -json -saveReport $reportPath

        # Load the analysis report as JSON
        $reportContent = Get-Content -Raw -Path $reportPath | ConvertFrom-Json

        # Extract information on flagged strings
        $flaggedStrings = $reportContent.FlaggedStrings | Where-Object { $_.Flag -ne "None" }

        # Extract information on flagged exports
        $flaggedExports = $reportContent.FlaggedExports | Where-Object { $_.Flag -ne "None" }

        # Display the results
        if ($flaggedStrings) {
            Write-Host "Flagged Strings:"
            foreach ($flaggedString in $flaggedStrings) {
                Write-Host "- String: $($flaggedString.Value)"
                Write-Host "  Flag: $($flaggedString.Flag)"
            }
        } else {
            Write-Host "No flagged strings found."
        }

        if ($flaggedExports) {
            Write-Host "Flagged Exports:"
            foreach ($flaggedExport in $flaggedExports) {
                Write-Host "- Export: $($flaggedExport.Value)"
                Write-Host "  Flag: $($flaggedExport.Flag)"
            }
        } else {
            Write-Host "No flagged exports found."
        }

        # Clean up the temporary report file
        Remove-Item -Path $reportPath -Force
    }
    else {
        Write-Host "No IOC detected in the target."
    }
}

# Invoke the function
Invoke-YaraAndPEStudio
