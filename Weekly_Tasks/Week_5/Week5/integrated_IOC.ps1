# Path to the YARA executable
$yaraPath = "D:\Files\Yara\yara64.exe"

# Path to the YARA rule file
$yaraRuleFile = "D:\Files\Yara\cap.yar"

# Path to the file or directory to scan
$targetPath = "D:\Files\Yara"

# Run YARA command to scan the target using the specified rule file
$result = & $yaraPath $yaraRuleFile $targetPath

# Process the YARA scan result
if ($result) {
    # Path to the PEStudio executable
    $pestudioPath = "D:\Files\PEStudio\pestudio\PEStudio.exe"

    # Array to store the flagged strings and exports
    $flaggedStrings = @()
    $flaggedExports = @()

    foreach ($executablePath in $result) {
        # Run PEStudio in command-line mode and save the analysis report to a temporary file
        $reportPath = [System.IO.Path]::GetTempFileName()
        & $pestudioPath -file $executablePath -quiet -export -string -json -saveReport $reportPath

        # Load the analysis report as JSON
        $reportContent = Get-Content -Raw -Path $reportPath | ConvertFrom-Json

        # Extract information on flagged strings
        $flaggedStrings += $reportContent.FlaggedStrings | Where-Object { $_.Flag -ne "None" }

        # Extract information on flagged exports
        $flaggedExports += $reportContent.FlaggedExports | Where-Object { $_.Flag -ne "None" }

        # Clean up the temporary report file
        Remove-Item -Path $reportPath -Force
    }

    # Display the flagged strings
    if ($flaggedStrings) {
        Write-Host "Flagged Strings:"
        foreach ($flaggedString in $flaggedStrings) {
            Write-Host "- String: $($flaggedString.Value)"
            Write-Host "  Flag: $($flaggedString.Flag)"

            # Perform real-time registry scanning using the flagged strings as IOCs
            ScanRegistry -RegistryPath "HKLM:\Software\Windows\CurrentVersion" -IOC $flaggedString.Value
        }
    }
    else {
        Write-Host "No flagged strings found."
    }

    # Display the flagged exports
    if ($flaggedExports) {
        Write-Host "Flagged Exports:"
        foreach ($flaggedExport in $flaggedExports) {
            Write-Host "- Export: $($flaggedExport.Value)"
            Write-Host "  Flag: $($flaggedExport.Flag)"

            # Perform real-time registry scanning using the flagged exports as IOCs
            ScanRegistry -RegistryPath "HKLM:\Software\Windows\CurrentVersion" -IOC $flaggedExport.Value
        }
    }
    else {
        Write-Host "No flagged exports found."
    }
}
else {
    Write-Host "No IOC detected in the target."
}

# Function to scan registry for potential IOCs
function ScanRegistry {
    param (
        [Parameter(Mandatory = $true)]
        [string]$RegistryPath,
        [Parameter(Mandatory = $true)]
        [string]$IOC
    )

    $keys = Get-ChildItem -Path $RegistryPath -Recurse -ErrorAction SilentlyContinue
    foreach ($key in $keys) {
        $keyValueNames = Get-ItemProperty -Path $key.PSPath | Select-Object -ExpandProperty PSChildName
        if ($keyValueNames -contains $IOC) {
            Write-Host "Potential IOC found in registry key: $($key.PSPath)"
            # You can take additional actions here, such as logging or notifying
        }
    }
}

# Specify the paths to scan
$systemFilesPath = "D:\Files\PEStudio\pestudio"

# Function to scan system files for potential IOCs
function ScanSystemFiles {
    param (
        [Parameter(Mandatory = $true)]
        [string]$FolderPath,
        [Parameter(Mandatory = $true)]
        [string]$IOC
    )

    $files = Get-ChildItem -Path $FolderPath -Recurse -File -ErrorAction SilentlyContinue
    foreach ($file in $files) {
        $content = Get-Content -Path $file.FullName -Raw -ErrorAction SilentlyContinue
        if ($content -match $IOC) {
            Write-Host "Potential IOC found in system file: $($file.FullName)"
            # You can take additional actions here, such as logging or quarantining the file
        }
    }
}

# Scanning system files using the flagged strings as IOCs
if ($flaggedStrings) {
    Write-Host "Scanning system files..."
    foreach ($flaggedString in $flaggedStrings) {
        ScanSystemFiles -FolderPath $systemFilesPath -IOC $flaggedString.Value
    }
}
