# Define the path to the executable file
$executablePath = "D:\Drive\APranav\6thS\Capstone\packed\upx-4.0.2-win64\infectd.exe"

# Calculate the hash of the executable file
$hashAlgorithm = [System.Security.Cryptography.SHA256]::Create()
$executableBytes = [System.IO.File]::ReadAllBytes($executablePath)
$hashBytes = $hashAlgorithm.ComputeHash($executableBytes)
$hash = [System.BitConverter]::ToString($hashBytes).Replace("-", "").ToLower()

# Construct the VirusTotal API URL
$apiUrl = "https://www.virustotal.com/api/v3/files/$hash"

# Specify your VirusTotal API key
$apiKey = "529b0215b4a80f64182c40669b362e2983967c9618b646bb250d4b729e590ed0"

# Set the headers for the API request
$headers = @{
    "x-apikey" = $apiKey
    "Content-Type" = "application/json"
}

# Submit the file hash to VirusTotal for analysis
$response = Invoke-RestMethod -Uri $apiUrl -Method Get -Headers $headers

# Check if the file has been analyzed
if ($response.data.attributes.last_analysis_results) {
    $detectionCount = ($response.data.attributes.last_analysis_results | Where-Object { $_.category -eq 'malicious' }).Count
    $totalEngines = $response.data.attributes.last_analysis_results.Count

    if ($detectionCount -gt 0) {
        Write-Host "The file has been flagged by $detectionCount / $totalEngines AV engines."
        # Stop the process executable
        # Stop-Process -Path $executablePath -Force
    } else {
        Write-Host "The file is clean. No detections found."
    }
} else {
    Write-Host "The file has not been analyzed by VirusTotal yet."
}
