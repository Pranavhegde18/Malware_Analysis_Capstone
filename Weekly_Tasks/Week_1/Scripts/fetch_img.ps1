# Set the array of IP addresses to check
$ipAddresses = @("127.0.0.1", "127.0.0.2", "127.0.0.123") # PROVIDE THE THREE SERVERS

# Set the port number to establish the socket connection
$port = 80

# Set the regex pattern to match the image file name
$regexPattern = @("image1.jpeg", "image2.jpeg")


# Loop through the IP addresses and try to establish a socket connection
foreach ($ip in $ipAddresses) {
    try {
        $client = New-Object System.Net.Sockets.TcpClient
        $client.Connect($ip, $port)
        if ($client.Connected) {
            Write-Host "Connected to $ip"

            # Fetch the directory listing from the server
            $directoryListing = Invoke-WebRequest -Uri "http://${ip}:$port/" -UseBasicParsing
            $rawHtmlContent = $directoryListing.Content

            # Search for the image file using regex in the raw HTML content
	    foreach  ($regex1 in $regexPattern)
	    {
            	$regex = [regex]::new($regex1)
           	$matches = $regex.Matches($rawHtmlContent)

           	if ($matches.Count -gt 0) {
                    # Get the first matching image file
                    $imageFileName = $matches[0].Value
                    # Download the image file
                    $imageData = Invoke-WebRequest -Uri "http://${ip}:$port/$imageFileName" -UseBasicParsing
                    Set-Content -Path "downloaded_image.jpeg" -Value $imageData.Content -Encoding Byte -Force

                    Write-Host "Image '$imageFileName' downloaded from $ip"
                    # Exit the loop if an image is downloaded
                    break
            	}
            	
                else {
                    Write-Host "No $regex1 image file found on $ip"
            	}
	     }
             if ($imageData.Content) {
                break   
             }
        }
    }
    catch {
        # Handle connection errors or move to the next IP address
        Write-Host "Connection to $ip failed: $_"
    }
}

# Clean up the socket connection
$client.Close()