# Set the array of IP addresses to check
$ipAddresses = @("127.0.0.1", "127.0.0.2", "127.0.0.123")

# Set the port number to establish the socket connection
$port = 8080

# Set the regex pattern to match the image file name
$regexPattern = "imagex\.jpeg"

# Loop through the IP addresses and try to establish a socket connection
foreach ($ip in $ipAddresses) {
    try {
        $client = New-Object System.Net.Sockets.TcpClient
        $client.Connect($ip, $port)
        if ($client.Connected) {
            Write-Host "Connected to $ip"

            # Fetch the directory listing from the server
            $directoryListing = Invoke-WebRequest -Uri "http://$ip:$port/" -UseBasicParsing
            $rawHtmlContent = $directoryListing.Content

            # Search for the image file using regex in the raw HTML content
            $regex = [regex]::new($regexPattern)
            $matches = $regex.Matches($rawHtmlContent)

            if ($matches.Count -gt 0) {
                # Get the first matching image file
                $imageFileName = $matches[0].Value

                # Download the image file
                $imageData = Invoke-WebRequest -Uri "http://$ip:$port/$imageFileName" -UseBasicParsing
                $imageData.Content | Out-File -FilePath "downloaded_image.jpeg" -Encoding Byte -Force

                Write-Host "Image '$imageFileName' downloaded from $ip"
            }
            else {
                Write-Host "No matching image file found on $ip"
            }

            # Exit the loop if an image is downloaded
            break
        }
    }
    catch {
        # Handle connection errors or move to the next IP address
        Write-Host "Connection to $ip failed: $_"
    }
}

# Clean up the socket connection
$client.Close()