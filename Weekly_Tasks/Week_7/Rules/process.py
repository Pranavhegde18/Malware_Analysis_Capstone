import re

# Read the Yara rule
with open('PEs.yara', 'r') as file:
    yara_rule = file.read()

# Extract the strings and their properties
strings = re.findall(r'\$(\w+)\s*=\s*{([^}]*)}', yara_rule)

# Initialize the new rule template
new_rule_template = '''rule {rule_name}
{{
    strings:
        {string}

    condition:
        any of them
}}'''

# Initialize a list to store the extracted data
extracted_data = []

# Initialize a variable to store the consolidated rules
consolidated_rules = ''

# Iterate through the strings and extract the data
for rule_name, string_data in strings:
    # Extract the string value
    string_value = re.search(r'"([^"]+)"', string_data)
    if string_value:
        string = string_value.group(1)
    else:
        string = string_data.strip()

    # Extract the data (e.g., 16/20 and entropy)
    data = re.findall(r'(\d+/\d+)\s*Entropy:\s*([\d.]+)', string_data)
    if data:
        for tp_rate, entropy in data:
            extracted_data.append((rule_name, tp_rate, entropy))
    else:
        extracted_data.append((rule_name, 'Data not found', 'Data not found'))

    # Create the new rule
    new_rule = new_rule_template.format(rule_name=rule_name, string=string)

    # Append the new rule to the consolidated rules
    consolidated_rules += f'{new_rule}\n'

# Save the consolidated rules to a file
with open('consolidated_rules.yar', 'w') as file:
    file.write(consolidated_rules)

# Print the extracted data
for rule_name, tp_rate, entropy in extracted_data:
    print(f'{rule_name}: TP Rate: {tp_rate}, Entropy: {entropy}')
