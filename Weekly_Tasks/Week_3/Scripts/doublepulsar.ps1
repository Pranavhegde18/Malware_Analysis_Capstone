# Function to listen on port 8000 and receive the "PullMe" message
function Receive-PullMessage {
    param (
        [int]$port
    )
    $listener = New-Object System.Net.Sockets.TcpListener([System.Net.IPAddress]::Any, $port)
    $listener.Start()
    $client = $listener.AcceptTcpClient()
    $stream = $client.GetStream()
    $reader = New-Object System.IO.StreamReader($stream)

    # Receive the message from the connecting host
    $message = $reader.ReadLine()

    $reader.Close()
    $stream.Close()
    $client.Close()
    $listener.Stop()

    return $message
}

# Check if port 8000 is open and receive the "PullMe" message
$port = 8000
$message = Receive-PullMessage -port $port

# If the received message is "PullMe", copy and execute the sample.ps1 script from the connecting host
if ($message -eq "PullMe") {
    $connectingHost = $client.Client.RemoteEndPoint.Address.ToString()

    # Define the source and destination paths
    $sourcePath = "\\$connectingHost\c$\Users\username\Desktop\test\sample.ps1"  # Replace with the actual path of sample.ps1 on the connecting host
    $destinationPath = "C:\sample.ps1"  # Specify the desired destination path on Host B

    # Read the content of sample.ps1 from the connecting host
    $sampleScriptContent = Invoke-Command -ComputerName $connectingHost -ScriptBlock {
        param($path)
        Get-Content -Path $path -Raw
    } -ArgumentList $sourcePath

    # Create a script block from the sample script content
    $sampleScriptBlock = [ScriptBlock]::Create($sampleScriptContent)

    # Execute the sample script block
    & $sampleScriptBlock
}

