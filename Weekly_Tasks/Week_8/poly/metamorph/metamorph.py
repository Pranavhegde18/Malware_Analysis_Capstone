import random
import string

def mutate_variable_names(code):
    # Extract all words from the code
    words = code.split()

    # Create a set of core commands to exclude
    core_commands = ["print", "input", "len"]

    # Create a mapping of old variable names to new random names
    mapping = {}
    for word in words:
        print("words",word)
        # if word.isalpha() and word not in core_commands:
        print(word.isidentifier())
        print(word.isalpha() )
        if word.isalpha() and not (word in core_commands):
            new_name = ''.join(random.choice(string.ascii_lowercase) for _ in range(len(word)))
            print("new name ",new_name)
            mapping[word] = new_name

    # Replace variable names in the code
    mutated_code = code
    for word, new_name in mapping.items():
        mutated_code = mutated_code.replace(word, new_name) 
    return mutated_code

def reorder_statements(code):
    # Split the code into individual statements
    # print("code erer",code)
    statements = code.split("\n")

    # Randomly reorder the statements
    random.shuffle(statements)

    # Join the reordered statements
    mutated_code = '\n'.join(statements)

    return mutated_code

def add_arbitrary_commands(code):
    # Generate a random number
    random_number = random.randint(1, 1000000)

    # Create the commands with the random number
    commands = [
        f'a_{random_number} = 123456789',
        f'a_{random_number} += 1',
        f'a_{random_number} -= 15',
        f'a_{random_number} -= 123456700',
    ]

    # Insert the commands randomly into the code
    code_lines = code.split('\n')
    insert_index = random.randint(0, len(code_lines) - 1)
    code_lines[insert_index:insert_index] = commands

    return '\n'.join(code_lines)

def generate_random_number():
    return random.sample(range(1, 1000), 1)

def metamorphic_engine(file_path):
    with open(file_path, 'r') as file:
        original_code = file.read()

    # Mutate variable names
    mutated_code = mutate_variable_names(original_code)
    # Reorder statements
    # print("mutate ",mutated_code)
    mutated_code = reorder_statements(mutated_code)

    # Add arbitrary commands
    mutated_code = add_arbitrary_commands(mutated_code)

    # Generate a random number for the file name
    random_number = generate_random_number()

    # Generate a new file name
    new_file_path = file_path.replace(".py", f"_metamorphic_{random_number}.py")

    # Save the mutated code to the new file
    with open(new_file_path, 'w') as file:
        file.write(mutated_code)

    print("Metamorphic code generated successfully.")


# Usage example
file_path = "poly_virus.py"
metamorphic_engine(file_path) # MODIFIED METAMORPHIC ENGINE WITH ARBITRARY COMMAND ADDITIONS