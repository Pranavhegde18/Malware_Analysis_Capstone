import sys
import os
import random

def extract_functions(script_path):
    with open(script_path, 'r') as file:
        script_content = file.read()

    function_list = []
    start_delimiter = '#!@'
    end_delimiter = '#$%'

    # Find function start and end positions
    start_positions = [pos + len(start_delimiter) for pos, _ in enumerate(script_content) if script_content.startswith(start_delimiter, pos)]
    end_positions = [pos for pos, _ in enumerate(script_content) if script_content.startswith(end_delimiter, pos)]

    # Extract functions
    for start_pos in start_positions:
        next_end_positions = [pos for pos in end_positions if pos > start_pos]
        if next_end_positions:
            end_pos = min(next_end_positions)
            function = script_content[start_pos:end_pos + len(end_delimiter)].strip()
            function_list.append(function)

    return function_list

def extract_global_declarations(script_content):
    global_declarations = []
    lines = script_content.splitlines()

    for line in lines:
        if line.strip().startswith('global'):
            global_declarations.append(line)

    return global_declarations

# Check if a script path is provided as a command-line argument
if len(sys.argv) < 2:
    print("Please provide the path to a Python script as a command-line argument.")
    sys.exit(1)

# Extract functions, global declarations, and other code from the provided script
script_path = sys.argv[1]
with open(script_path, 'r') as file:
    script_content = file.read()

functions = extract_functions(script_path)
global_declarations = extract_global_declarations(script_content)

# Extract import statements
import_statements = []
lines = script_content.splitlines()

for line in lines:
    if line.startswith('import') or line.startswith('from'):
        import_statements.append(line)

# Extract other code
other_code = []
current_section = None

for line in lines:
    line = line.strip()

    if line.startswith('#!@'):
        current_section = 'functions'
    elif line.startswith('#$%'):
        current_section = None
    elif current_section is None:
        if line and line not in import_statements and line not in global_declarations and line not in functions:
            other_code.append(line)

# Shuffle the functions
random.shuffle(functions)

# Update the original script file with shuffled code
with open(script_path, 'w') as original_file:
    # Write import statements
    for import_statement in import_statements:
        original_file.write(import_statement)
        original_file.write('\n')

    # Write global declarations
    for global_declaration in global_declarations:
        original_file.write(global_declaration)
        original_file.write('\n')

    # Write shuffled functions
    for function in functions:
        original_file.write("#!@\n")
        original_file.write(function)
        original_file.write('\n\n')

    # Write other code
    for code_line in other_code:
        original_file.write(code_line)
        original_file.write('\n')

# Print success message
print(f"Code shuffled and written back to {script_path}")
