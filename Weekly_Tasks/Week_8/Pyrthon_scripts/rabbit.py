import re
import random
import os
import sys

def get_function_ranges(lines):
    function_ranges = []
    current_function = None
    start_line = None

    for line_num, line in enumerate(lines, start=1):
        if re.match(r'\s*def\s+\w+\(', line):
            if current_function is None:
                current_function = re.findall(r'def\s+(\w+)\(', line)[0]
                start_line = line_num
            else:
                function_ranges.append((current_function, start_line, line_num - 1))
                current_function = re.findall(r'def\s+(\w+)\(', line)[0]
                start_line = line_num

    if current_function is not None:
        function_ranges.append((current_function, start_line, len(lines)))

    return function_ranges

def insert_lines_between_functions(lines, input_string):
    function_ranges = get_function_ranges(lines)
    if len(function_ranges) < 2:
        print("\nInsufficient number of functions to insert lines.")
        return

    random_pair = random.choice(function_ranges[:-1])
    _, start1, end1 = random_pair
    _, start2, _ = function_ranges[function_ranges.index(random_pair) + 1]

    lines.insert(end1, '\n' * (end1 - start1 + 1) + input_string + '\n')

    # print("Adjacent functions in:")
    # for function, start, end in function_ranges:
    #     print(f"Function: {function}")
    #     print(f"Starting line: {start}, Ending line: {end}")
    #     print()

    # print("Chosen random function pair:")
    # print(f"Function pair: {random_pair[0]} <-> {function_ranges[function_ranges.index(random_pair) + 1][0]}")
    # print(f"Starting line: {start1}, Ending line: {end1}")
    # print()

    # print("Input string inserted:\n")
    # print(input_string)
    # print("Lines successfully inserted between functions.\n")

    return lines

def read_functions_from_file(file_path):
    with open(file_path, 'r') as file:
        lines = file.readlines()

    functions = []
    current_function = None

    for line in lines:
        if re.match(r'\s*def\s+\w+\(', line):
            if current_function is not None:
                functions.append(current_function)
            current_function = line
        elif current_function is not None:
            current_function += line

    if current_function is not None:
        functions.append(current_function)

    return functions

def rearrange_functions(file_path, func_file_path):
    # Read the content of file_path
    with open(file_path, 'r') as file:
        lines = file.readlines()

    # Read the functions from 'func.py'
    function_contents = read_functions_from_file(func_file_path)
    random.shuffle(function_contents)

    inserted_functions = set()
    for function_content in function_contents:
        if function_content not in inserted_functions:
            lines = insert_lines_between_functions(lines, function_content)
            inserted_functions.add(function_content)

    # Prompt the user for the function call to be added
    function_call = input("Enter the function call to be added: ").lstrip()

    # Add the function call to the very end of the file
    lines.append(function_call)
    lines.append('\n')

    # Write the modified code back to file_path
    with open(file_path, 'w') as file:
        file.writelines(lines)

    print("Modified code saved to:", file_path)

# Check if the file paths are provided as command-line arguments
if len(sys.argv) < 3:
    print("Usage: python script.py <file_path> <func_file_path>")
    sys.exit(1)

# Get the file paths from command-line arguments
file_path = sys.argv[1]
func_file_path = sys.argv[2]

# Check if the files exist
if not os.path.isfile(file_path) or not os.path.isfile(func_file_path):
    print("One or more files not found. Please enter valid file paths.")
    sys.exit(1)

# Call the function
rearrange_functions(file_path, func_file_path)
